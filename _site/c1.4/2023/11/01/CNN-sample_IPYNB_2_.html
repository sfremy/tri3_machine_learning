<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Personal Project - Convolutional Neural Network | CompSci Blogs</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Personal Project - Convolutional Neural Network" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="CNN development" />
<meta property="og:description" content="CNN development" />
<link rel="canonical" href="http://0.0.0.0:4200/csablog/c1.4/2023/11/01/CNN-sample_IPYNB_2_.html" />
<meta property="og:url" content="http://0.0.0.0:4200/csablog/c1.4/2023/11/01/CNN-sample_IPYNB_2_.html" />
<meta property="og:site_name" content="CompSci Blogs" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-11-01T00:00:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Personal Project - Convolutional Neural Network" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-11-01T00:00:00-07:00","datePublished":"2023-11-01T00:00:00-07:00","description":"CNN development","headline":"Personal Project - Convolutional Neural Network","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4200/csablog/c1.4/2023/11/01/CNN-sample_IPYNB_2_.html"},"url":"http://0.0.0.0:4200/csablog/c1.4/2023/11/01/CNN-sample_IPYNB_2_.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/csablog/assets/css/style.css?v=63838579fe931db354edc3470df1d250d658967f">
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/csablog/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1><a href="http://0.0.0.0:4200/csablog/">CompSci Blogs</a></h1>

        

        <p>August 2023 to June 2024</p>

        
        <p class="view"><a href="https://github.com/sfremy/csablog">View the Project on GitHub <small>sfremy/csablog</small></a></p>
        

        

        <header class="site-header">

  <div id="header">
    <nav>
      <ul>
        <li class="fork"><a href="/csablog/">Home</a></li>
        <li class="fork"><a href="/csablog/csp">CompSci</a></li>
        <li class="fork"><a href="/csablog/blogs">Blogs</a></li>
        <li class="fork"><a href="/csablog/login">Login</a></li>
        <li class="title"><a href="https://github.com/sfremy/csablog#readme">View On GitHub</a></li>
      </ul>
    </nav>
  </div><!-- end header -->
</header>

        
      </header>
      <section>

      <small>1 November 2023</small>
<h1>Personal Project - Convolutional Neural Network</h1>

<p class="view">by </p>

<h1 id="searching-for-planets-with-convolutional-neural-networks">Searching for Planets with Convolutional Neural Networks</h1>
<p>This is a section of code from a AI-based scientific investigation of circumbinary planets. I will not explain the exact specifics of the code objectives since they are irrelevant to this class but all the features developed are here. Note that this does NOT work in VSCode - an excessive number of external dependencies are necessary and I am not working on it in here.</p>

<h4 id="key-features">Key Features:</h4>
<ul>
  <li>Passes negative and positive training data in numpy .npz files to a custom Keras convolutional neural network</li>
  <li>Manufactures training datasets which the CNN can use</li>
  <li>Trains the neural network using Adam optimizer</li>
  <li>Allows user to select device from CUDA visible options and determine training parameters</li>
  <li>Trains and saves a neural network model using all parameters passed</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># os.environ["CUDA_DEVICE_ORDER"] = "PCI_BUS_ID"   # see issue #152
# os.environ["CUDA_VISIBLE_DEVICES"] = ""
</span><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">opj</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.client</span> <span class="kn">import</span> <span class="n">device_lib</span>
<span class="kn">import</span> <span class="nn">astropy</span>

<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="s">"&lt;style&gt;.container { width:100% !important; }&lt;/style&gt;"</span><span class="p">))</span>

<span class="s">'''
Imports packages of functions from transit_utils and model_training_toolkit, which are my own libraries

import transit_utils as utils
import model_training_toolkit as modelkit
'''</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">process_time</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/var/folders/mh/dn_3qv0s6dndm54j9k1xw61h0000gn/T/ipykernel_7115/2357884589.py:11: DeprecationWarning: Importing display from IPython.core.display is deprecated since IPython 7.14, please import from IPython display
  from IPython.core.display import display, HTML
</code></pre></div></div>

<style>.container { width:100% !important; }</style>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Select a hardware device on which to run the CNN training
</span>
<span class="n">proc_hardware_choice</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">if</span> <span class="n">proc_hardware_choice</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">proc_hardware_name</span> <span class="o">=</span> <span class="s">'/gpu:0'</span>
    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'CUDA_VISIBLE_DEVICES'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'1'</span>
    
<span class="k">elif</span> <span class="n">proc_hardware_choice</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">proc_hardware_name</span> <span class="o">=</span> <span class="s">'/gpu:1'</span>
    
<span class="k">elif</span> <span class="n">proc_hardware_choice</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">proc_hardware_name</span> <span class="o">=</span> <span class="s">'/cpu:0'</span>
    <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'CUDA_VISIBLE_DEVICES'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'-1'</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'ERROR: You didnt make a proper choice. Defaulting to CPU processing.'</span><span class="p">)</span>
    <span class="n">proc_hardware_name</span> <span class="o">=</span> <span class="s">'/cpu:0'</span>
    
<span class="k">print</span><span class="p">(</span><span class="s">'Using hardware name ='</span><span class="p">,</span> <span class="n">proc_hardware_name</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#These names are npz files I made through an iterative data synthesis model based on the other file
# filelist = ['100K_transformed.npz', 'recovery/training_data/5K_foldless_trainingdata.npz']
</span><span class="n">filelist</span> <span class="o">=</span> <span class="p">[</span><span class="s">'recovery/training_data/5K_transformed.npz'</span><span class="p">]</span>

<span class="n">plc</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">nlc</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="s">'poslc'</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="p">)[</span><span class="s">'neglc'</span><span class="p">]</span>
    
    <span class="n">plc</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">nlc</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    
<span class="n">positive_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">plc</span><span class="p">)</span>
<span class="n">negative_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">nlc</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot a sample from the loaded data as a sanity check.
</span>
<span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">negative_matrix</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positive_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Make testing and training datasets
</span><span class="s">'''mk_set is a function from my package model_traning_toolkit which takes two sets of arrays 
(positive_matrix and negative_matrix) and randomly shuffles them into a 2D x_train and y_train array.
'''</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">modelkit</span><span class="p">.</span><span class="n">mk_set</span><span class="p">(</span><span class="n">positive_matrix</span><span class="p">,</span> <span class="n">negative_matrix</span><span class="p">)</span>


<span class="c1"># Reshape arrays to make tensorflow happy.
</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train</span><span class="p">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">x_train</span> <span class="o">=</span> <span class="n">x_train</span><span class="p">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">x_train</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_train</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>

<span class="n">np</span><span class="p">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x_train</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Training process parameters to pass to keras
</span><span class="n">model_name</span> <span class="o">=</span> <span class="s">'model_folded_v2'</span> <span class="c1"># Name the model to write to
</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">80</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">'data'</span><span class="p">)</span>
<span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">'tb_logs'</span><span class="p">)</span>
<span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s">'data'</span><span class="p">,</span> <span class="s">'models'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Keras model layers
</span><span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Dense</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">Reshape</span><span class="p">,</span>
    <span class="n">GlobalMaxPooling1D</span><span class="p">,</span> <span class="n">Lambda</span><span class="p">,</span>
    <span class="n">Conv2D</span><span class="p">,</span> <span class="n">GaussianNoise</span><span class="p">,</span>
    <span class="n">Cropping2D</span><span class="p">,</span> <span class="n">Concatenate</span><span class="p">,</span> <span class="n">ZeroPadding2D</span><span class="p">)</span>

<span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">backend</span><span class="p">.</span><span class="n">clear_session</span><span class="p">()</span>

<span class="c1"># -------------------------------------------------
# Circular Convolutional Layer
</span>
<span class="k">def</span> <span class="nf">CConv2D</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'linear'</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s">'valid'</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s">'glorot_uniform'</span><span class="p">,</span> <span class="n">kernel_regularizer</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">CConv2D_inner</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="c1"># padding (see https://www.tensorflow.org/api_guides/python/nn#Convolution)
</span>        <span class="n">in_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">in_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">get_shape</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">in_height</span> <span class="o">%</span> <span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">pad_along_height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pad_along_height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">kernel_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">in_height</span> <span class="o">%</span> <span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">in_width</span> <span class="o">%</span> <span class="n">strides</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">pad_along_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">strides</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pad_along_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">in_width</span> <span class="o">%</span> <span class="n">strides</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">pad_top</span> <span class="o">=</span> <span class="n">pad_along_height</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">pad_bottom</span> <span class="o">=</span> <span class="n">pad_along_height</span> <span class="o">-</span> <span class="n">pad_top</span>
        <span class="n">pad_left</span> <span class="o">=</span> <span class="n">pad_along_width</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">pad_right</span> <span class="o">=</span> <span class="n">pad_along_width</span> <span class="o">-</span> <span class="n">pad_left</span>

        <span class="c1"># left and right side for padding
</span>        <span class="n">pad_left</span> <span class="o">=</span> <span class="n">Cropping2D</span><span class="p">(</span><span class="n">cropping</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">in_width</span><span class="o">-</span><span class="n">pad_left</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">pad_right</span> <span class="o">=</span> <span class="n">Cropping2D</span><span class="p">(</span><span class="n">cropping</span><span class="o">=</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">in_width</span><span class="o">-</span><span class="n">pad_right</span><span class="p">)))(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># add padding to incoming image
</span>        <span class="n">conc</span> <span class="o">=</span> <span class="n">Concatenate</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)([</span><span class="n">pad_left</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">pad_right</span><span class="p">])</span>

        <span class="c1"># top/bottom padding options
</span>        <span class="k">if</span> <span class="n">padding</span> <span class="o">==</span> <span class="s">'same'</span><span class="p">:</span>
            <span class="n">conc</span> <span class="o">=</span> <span class="n">ZeroPadding2D</span><span class="p">(</span><span class="n">padding</span><span class="o">=</span><span class="p">{</span><span class="s">'top_pad'</span><span class="p">:</span> <span class="n">pad_top</span><span class="p">,</span>
                                          <span class="s">'bottom_pad'</span><span class="p">:</span> <span class="n">pad_bottom</span><span class="p">})(</span><span class="n">conc</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">padding</span> <span class="o">==</span> <span class="s">'valid'</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Padding "{}" does not exist!'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">padding</span><span class="p">))</span>

        <span class="c1"># perform the circular convolution
</span>        <span class="n">cconv2d</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
                         <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
                         <span class="n">padding</span><span class="o">=</span><span class="s">'valid'</span><span class="p">,</span>
                         <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">kernel_initializer</span><span class="p">,</span>
                         <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">kernel_regularizer</span><span class="p">)(</span><span class="n">conc</span><span class="p">)</span>

        <span class="c1"># return circular convolution layer
</span>        <span class="k">return</span> <span class="n">cconv2d</span>
    <span class="k">return</span> <span class="n">CConv2D_inner</span>


<span class="c1"># -------------------------------------------------
# The model
</span>
<span class="k">def</span> <span class="nf">model_fun</span><span class="p">(</span><span class="n">data_shape</span><span class="p">):</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">data_shape</span><span class="p">)</span>
    
    <span class="c1"># New layer: Adds a small amount of noise to each sample during training
</span>    <span class="n">layer</span> <span class="o">=</span> <span class="n">GaussianNoise</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">100</span><span class="p">)(</span><span class="n">inputs</span><span class="p">)</span>
    
    <span class="c1"># New layer: Make tensor 2D for new 2D convolution layers
</span>    <span class="n">layer</span> <span class="o">=</span> <span class="n">Reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="c1"># New layer: Circular convolution layer
</span>    <span class="n">layer</span> <span class="o">=</span> <span class="n">CConv2D</span><span class="p">(</span>
        <span class="n">filters</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> 
        <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> 
        <span class="n">activation</span><span class="o">=</span><span class="s">'linear'</span><span class="p">,</span>
    <span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="c1"># New layer: Circular convolution layer
</span>    <span class="n">cconv2_filter_cnt</span> <span class="o">=</span> <span class="mi">256</span>
    <span class="n">layer</span> <span class="o">=</span> <span class="n">CConv2D</span><span class="p">(</span>
        <span class="n">filters</span><span class="o">=</span><span class="n">cconv2_filter_cnt</span><span class="p">,</span> 
        <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> 
        <span class="n">activation</span><span class="o">=</span><span class="s">'linear'</span><span class="p">,</span>
    <span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="c1"># New layer: Make tensor 1D
</span>    <span class="n">layer</span> <span class="o">=</span> <span class="n">Reshape</span><span class="p">((</span><span class="n">data_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="n">cconv2_filter_cnt</span><span class="p">))(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="c1"># New layer: Global pooling
</span>    <span class="n">layer</span> <span class="o">=</span> <span class="n">GlobalMaxPooling1D</span><span class="p">()(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="n">layer</span> <span class="o">=</span> <span class="n">Flatten</span><span class="p">()(</span><span class="n">layer</span><span class="p">)</span>

    <span class="n">layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="n">layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="n">layer</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">)(</span><span class="n">layer</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>

<span class="c1"># Create model
</span><span class="n">model</span> <span class="o">=</span> <span class="n">model_fun</span><span class="p">(</span><span class="n">x_train</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<span class="c1"># Show model summary
</span><span class="n">model</span><span class="p">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Train and test the model
</span><span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">RMSprop</span><span class="p">,</span> <span class="n">Adam</span><span class="p">,</span> <span class="n">SGD</span><span class="p">,</span> <span class="n">Adadelta</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.callbacks</span> <span class="kn">import</span> <span class="n">ModelCheckpoint</span><span class="p">,</span> <span class="n">EarlyStopping</span>
<span class="kn">from</span> <span class="nn">livelossplot.tf_keras</span> <span class="kn">import</span> <span class="n">PlotLossesCallback</span>

<span class="c1"># Set optimizer and optimization options
# optimizer = SGD(learning_rate=0.001, decay=1e-6, momentum=0.9, nesterov=True)
</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">5e-7</span><span class="p">)</span>

<span class="c1"># Compile the model (required)
</span><span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span> 
              <span class="c1">#optimizer= 'adam',
</span>              <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizer</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>


<span class="c1"># Set early stopping (during training) options
</span><span class="n">early_stopping</span> <span class="o">=</span> <span class="n">EarlyStopping</span><span class="p">(</span><span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span> 
                               <span class="n">patience</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> 
                               <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                               <span class="n">mode</span><span class="o">=</span><span class="s">'auto'</span><span class="p">)</span>


<span class="c1"># Setup training checkpoint options
</span><span class="n">model_checkpoint</span> <span class="o">=</span> <span class="n">ModelCheckpoint</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.hdf5'</span><span class="p">),</span> 
                                   <span class="n">monitor</span><span class="o">=</span><span class="s">'val_loss'</span><span class="p">,</span> 
                                   <span class="n">save_best_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="c1"># Define callbacks, which TF will call on after each training epoch finishes
</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">model_checkpoint</span><span class="p">,</span>  <span class="c1"># Make checkpoints
</span>             <span class="n">PlotLossesCallback</span><span class="p">(),</span> <span class="c1"># Show training progress (model accuracy and loss)
</span>            <span class="p">]</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#Run the keras model above through the training process with the specified dataset and training epochs
</span>
<span class="k">print</span><span class="p">(</span><span class="n">proc_hardware_name</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="n">proc_hardware_name</span><span class="p">):</span> <span class="c1"># With the hardware chosen, train the model!
</span>    
    <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span>
              <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> 
              <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span>
              <span class="n">validation_split</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
              <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
              <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">,</span>
             <span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load the model weights at the checkpoint which had the best results
</span><span class="n">model</span><span class="p">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s">'models'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span> <span class="o">+</span> <span class="s">'.hdf5'</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Save the entire model
</span><span class="n">model</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">opj</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="s">'models'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span> <span class="o">+</span> <span class="s">'_save1.hd5'</span><span class="p">))</span>
</code></pre></div></div>



  <small>tags: <em></em></small>


      </section>
      <footer>
        
        <p>This project is maintained by <a href="https://github.com/sfremy">sfremy</a></p>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
  </body>
</html>